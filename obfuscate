-- Obfuscator.Client.lua (Fixed for Roblox GitHub)
local RunService = game:GetService("RunService")

local ClientObfuscator = {}

function ClientObfuscator.ProtectAndRun(codeString)
    local cleanCode = codeString:gsub("%-%-%[%[", "COMMENT_OPEN"):gsub("%]%]", "COMMENT_CLOSE")
    
    local encodedParts = {}
    for i = 1, #cleanCode do
        local char = cleanCode:sub(i, i)
        local byte = string.byte(char)
        local encodedByte = byte ~ ((i * 11 + 5) % 256)
        table.insert(encodedParts, tostring(encodedByte))
    end
    
    -- FIX: Gunakan load, bukan loadstring (Roblox compatible)
    local loaderCode = 
    "local parts = {" .. table.concat(encodedParts, ",") .. "} " ..
    "local result = '' " ..
    "for i = 1, #parts do " ..
    "   local key = (i * 11 + 5) % 256 " ..
    "   result = result .. string.char(parts[i] ~ key) " ..
    "end " ..
    "result = result:gsub('COMMENT_OPEN', '--[['):gsub('COMMENT_CLOSE', ']]') " ..
    "local func, err = load(result) " ..
    "if func then return func() else return 'Load Error: ' .. tostring(err) end"

    if not RunService:IsClient() then
        return "Client only"
    end
    
    -- FIX: Gunakan load dengan environment yang benar
    local func, err = load(loaderCode)
    if func then
        -- Set environment dengan fungsi yang tersedia di Roblox
        setfenv(func, {
            load = load,
            string = string,
            table = table,
            tostring = tostring,
            pcall = pcall,
            print = print,
            warn = warn,
            game = game,
            script = script,
            workspace = workspace
        })
        return func()
    else
        return "Compile Error: " .. tostring(err)
    end
end

return ClientObfuscator
